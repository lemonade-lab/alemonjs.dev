---
title: V2.1.17
description: 针对useSubscribe的优化
# slug: welcome-docusaurus-v2
authors: ningmengchongshui
tags: [更新]
image: https://i.imgur.com/mErPwqL.png
hide_table_of_contents: false
---

# 更新记录

## `useSubscribe`

> 已经修复，不可以在回调中调用 subscribe.cancel(sub) 的限制

```ts title="response/**/*/res.ts"
import { Text, useMessage, useSubscribe } from 'alemonjs'
const selects = onSelects(['message.create', 'private.message.create'])
export default onResponse(selects, event => {
  const [message] = useMessage(event)
  const [subscribe] = useSubscribe(event, selects)

  message.send(format(Text('请输入密码'), Text('123456')))

  // 订阅 res 挂载之前的
  const sub = subscribe.mount(
    (event, next) => {
      // 执行时，会默认调用，cancel。因此下面这段代码可移除。
      subscribe.cancel(sub)

      // 当然也可以手动调用，可用于解决 next 默认保持继续的限制
      // 比如：
      const a = 1
      const b = 1
      if (a === b) {
        // next() 继续保持订阅。
        next(true) // 继续能保持订阅，且前往下一个订阅（如果有的话）
        subscribe.cancel(sub) // 取消继续订阅。
      }
    },
    ['UserId']
  )

  const timeout = setTimeout(() => {
    // 取消订阅
    subscribe.cancel(sub)
    // 发送消息
    message.send(format(Text('登录超时')))
  }, 1000 * 10)
})
```
